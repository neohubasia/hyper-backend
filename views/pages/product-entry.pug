extends ../includes/layout-main
block content
  main.ml-sm-auto.px-md-4(role='main')

    include ./../includes/layout-entry-header

    //- this is single file upload  - work well
    form#uploadForm(method='POST' action='/file/upload/products' enctype="multipart/form-data")
      input#file-input(type='file' name='uploaded_file')
      //- input#file-input-btn(type='submit' name='uploaded_file_btn' value='Upload')

    //- this is multiple files upload - work well
    //- form(method='POST' action='/file/multiUpload/multitest' enctype='multipart/form-data')
    //-   input(type='file' name='uploaded_files' multiple='')
    //-   input(type='submit' name='uploaded_files_btn' value='Upload')

    include ./../includes/layout-entry-form
      block inputs

        div.form-group.d-none 
          div.row.remove-img-list

        div.form-group  
          div.row.img-list
            .col-xs-6.col-sm-6.col-md-6.col-lg-2.item.d-flex.justify-content-center.img-container
              img.m-1.p-3.add-img-wrapper#add-image(src=app.icons.FLAT_PLUS, alt="", srcset="" width="360" height="360")

            - var imageArray = data.images || [];
            if imageArray.length > 0
              each images in data.images
                .col-xs-6.col-sm-6.col-md-6.col-lg-2.item.d-flex.justify-content-center.img-container
                  input.uploaded-files(type="hidden", name="images[]", value=`${images}`)
                  img.m-1.img.img-thumbnail(src=`${images}`, alt="", srcset="" width="360" height="360")
                  button.btn.remove-file(type="button") Remove

        div.form-group.row
          div.col-sm-6
            label.control-label(for='name') Name
            input.form-control.input-sm#name(type='text', name='name', value=data.name, maxlength="55" required autofocus)
          div.col-sm-6
            label.control-label(for='sku') Code
            input.form-control.input-sm#sku(type='text', name='sku', value=data.sku, maxlength="55" required autofocus)
      
        div.form-group.row
          div.col-sm-6
            - var category_id =  data.category_id || "#";
            label.control-label(for='category') Category
            select.form-control.selectpicker#category_id(name='category_id' value=category_id._id data-value=category_id._id, data-live-search="true", data-size="8" required)
          div.col-sm-6
            label.control-label(for='stock') Stock
            input.form-control.input-sm#prstockice(type='text', name='stock' , value=data.stock autocomplete="off" required)
          //- div.col-sm-6
          //-   - var inventory_id =  data.inventory_id || "#";
          //-   label.control-label(for='inventory') Inventory
          //-   select.form-control.selectpicker#inventory_id(name='inventory_id' value=inventory_id._id data-value=inventory_id._id, data-live-search="true", data-size="8" required)

        //- div.form-group.row
        //-   div.col-sm-6
        //-     label.control-label(for='features') Feature
        //-     textarea.form-control.input-sm#features(name='features', autofocus)= data.features
        //-   div.col-sm-6
        //-     label.control-label(for='description') Description
        //-     textarea.form-control.input-sm#description(name='description', autofocus)= data.description

        div.form-group.row
          div.col-sm-6
            label.control-label(for='price') Price
            input.form-control.input-sm#price(type='text', name='price' , value=data.price autocomplete="off" required)
          div.col-sm-6
            label.control-label(for='description') Description
            textarea.form-control.input-sm#description(name='description', autofocus)= data.description
          //- div.col-sm-6
          //-   - var discount_id =  data.discount_id || "#";
          //-   label.control-label(for='discount') Discount
          //-   select.form-control.selectpicker#discount_id(name='discount_id' value=discount_id._id data-value=discount_id._id, data-live-search="true", data-size="8")
            
        div.form-group.row
          div.col-sm-6
            - var discount_id =  data.discount_id || "#";
            label.control-label(for='discount') Discount
            select.form-control.selectpicker#discount_id(name='discount_id' value=discount_id._id data-value=discount_id._id, data-live-search="true", data-size="8")
          div.col-sm-6
            label.control-label(for='status') Status
            div.radio.radio-toolbar.row
              div.col-sm-6.col-xl-3
                input#statusActive.radiobox(type='radio', name='status', value="1" checked)
                label.ml-1(for='statusActive') &nbsp; Active
              div.col-sm-6.col-xl-3
                input#statusInactive.radiobox(type='radio', name='status', value="0")
                label.ml-1(for='statusInactive') &nbsp; Inactive

        include ./../includes/layout-entry-btn

    form#postSuccessForm(method='GET', action=page.list.url)
  script.
    $(document).ready(function() {
      var token = '!{token}';
      var maxImageCount  = 5;
      var editMode = $("input[name='id']").val();
      $('#alert').hide();
      $('#uploadForm').hide();

      var status = "!{data.status}";
      if (status && status == "false")
        $('#statusInactive').attr("checked", "checked");

      $('#entryForm').submit(function (e) {
        e.preventDefault();
        $.ajax({
          url: $(this).attr('action'),
          type:$(this).attr('method'),
          data: $(this).serialize(),
          success: function (data) {
            handleAlert(data);
          },
          error: function (data) {
            console.log('An error occurred.');
            console.log(data);
          },
        });
      });

      ajaxLoadOption({
        type: "GET",
        url:"/api/product_categories",
        selectId: "#category_id",
        showKey: "name",
        filterObj: { },
        token: token
      });
      ajaxLoadOption({
        type: "GET",
        url:"/api/product_inventories",
        selectId: "#inventory_id",
        showKey: "quantity",
        filterObj: { },
        token: token
      });
      ajaxLoadOption({
        type: "GET",
        url:"/api/discounts/activeData",
        selectId: "#discount_id",
        showKey: "name",
        filterObj: { },
        token: token
      });

      //- $('#category_id').on('change', function() {
      //-   // get value to filter
      //-   var category_id = $(this).val() || // get value [new entry]
      //-                $(this).data('value'); // get value [edit entry]
      //-   //- if(cityid) {
      //-   //-   ajaxLoadOption({
      //-   //-     type: "GET",
      //-   //-     url:"/api/township",
      //-   //-     selectId: "#townshipid",
      //-   //-     showKey: "township_mm",
      //-   //-     filterObj: { cityid: cityid },
      //-   //-     token: token
      //-   //-   });
      //-   //- }
      //- });

      if (editMode && typeof editMode === "string")
        $('#category_id').trigger('change');

      $('#add-image').on('click', function() {
        //- $(this).css('background-color', '#fff');

        var imgCount  = $(".img-list").children().length || 0;

        if (imgCount -1 <  maxImageCount) 
          $('#file-input').trigger('click');
        else
          swalWarning({
            position: "top",
            icon: "warning",
            title: "Warning Message",
            text: "The specified number of images has been reached",
          });
      });

      $('#file-input').on('change', function(e) {
        e.preventDefault();
        if ( $(this).val() != "" ) {
          $('#uploadForm').submit();
        }
      });
      
      // multi/part  form submit
      $('#uploadForm').submit(function (e) {
        e.preventDefault();

        ajaxProductUploadForm({
          imgParentDiv: '.img-list',
          _this: this,
          token: token
        });

        $('#file-input').val(null);
      });


      $(document).on('click', '.remove-file', function () {
        // remove element
        var backupSrc = $(this).closest('div').find('img.img').attr('src');
        var makeInput = `<input class="remove-files" type="hidden" name="remove_images[]" value=${backupSrc} />`;

        $(".remove-img-list").append(makeInput);
        $(this).parent().remove();
      });

    });